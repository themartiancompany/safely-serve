#!/usr/bin/env node

// SPDX-License-Identifier: AGPL-3.0-or-later

//    ----------------------------------------------------------------------
//    Copyright Â© 2024, 2025  Pellegrino Prevete
//
//    All rights reserved
//    ----------------------------------------------------------------------
//
//    This program is free software: you can redistribute it and/or modify
//    it under the terms of the GNU Affero General Public License as published by
//    the Free Software Foundation, either version 3 of the License, or
//    (at your option) any later version.
//
//    This program is distributed in the hope that it will be useful,
//    but WITHOUT ANY WARRANTY; without even the implied warranty of
//    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//    GNU Affero General Public License for more details.
//
//    You should have received a copy of the GNU Affero General Public License
//    along with this program.  If not, see <https://www.gnu.org/licenses/>.


const
  { spawn } =
    require(
      "node:child_process");
/*global _spawn*/
const
  _spawn =
    spawn;
const
  _cert_tools_module =
    require(
      'cert-tools');
/*global _cert_gen*/
const
  _cert_gen =
    _cert_tools_module._cert_gen;
const
  _sha_module =
    require(
      'js-sha256');
/*global _sha256*/
const
  _sha256 =
    _sha_module.sha256;
const
  _libcrash =
  require(
    'crash-js');
/*global _dirname*/
const
  _dirname =
    _libcrash._dirname;
/*global _error_display*/
const
  _error_display =
    _libcrash._error_display;
/*global _file_exists*/
const
  _file_exists =
    _libcrash._file_exists;
/*global _mkdir*/
const
  _mkdir =
    _libcrash._mkdir;
/*global _msg_info*/
const
  _msg_info =
    _libcrash._msg_info;
/*global _msg_error*/
const
  _msg_error =
    _libcrash._msg_error;

function
  _path_encode(
    _path) {
  const
    _string =
      _sha256(
        _path + "\n");
  return _string;
}

function
  _serve_close_callback_get(
    _output) {
  const
    _close_callback =
      function(
        _code) {
      console.log(
        `Exit code: ${_code}`);
      console.log(
        `Output: ${_output}`);
    };
  return _close_callback;
}

function
  _serve_data_callback_get(
    _output) {
  const
    _data_callback =
      function(
        _data) {
      _data =
        _data.toString();
      console.log(
        _data);
      _output +=
        _data;
    };
  return _data_callback;
}

function
  _npx_cmdline_get(
    _target_directory,
    _listen_uris,
    _target_port,
    _index_redirect,
    _debug_enabled,
    _config_file,
    _logging_disabled,
    _cors_enabled,
    _clipboard_disabled,
    _compression_disabled,
    _etag_disabled,
    _symlinks_enabled,
    _ssl_cert,
    _ssl_key,
    _ssl_pass,
    _port_switching_disabled) {
  let
    _uri;
  const
    _cmd_args = [
      "serve"
    ];
  for ( _uri of _listen_uris ) {
    _cmd_args.push(
      "-l",
      _uri);
  }
  _cmd_args.push(
    "-p",
    _target_port);
  if ( _index_redirect == "y" ) {
    _cmd_args.push(
      "--single");
  }
  if ( _debug_enabled != "n" ) {
    _cmd_args.push(
      "--debug");
  }
  if ( _config_file != "" ) {
    _cmd_args.push(
      "--config",
      _config_file);
  }
  if ( _logging_disabled == "y" ) {
    _cmd_args.push(
      "--no-request-logging");
  }
  if ( _cors_enabled == "y" ) {
    _cmd_args.push(
      "--cors");
  }
  if ( _clipboard_disabled == "y" ) {
    _cmd_args.push(
      "--no-clipboard");
  }
  if ( _compression_disabled == "y" ) {
    _cmd_args.push(
      "--no-compression");
  }
  if ( _etag_disabled == "y" ) {
    _cmd_args.push(
      "--no-etag");
  }
  if ( _symlinks_enabled == "y" ) {
    _cmd_args.push(
      "--symlinks");
  }
  if ( _port_switching_disabled == "y" ) {
    _cmd_args.push(
      "--no-port-switching");
  }
  if ( _ssl_cert != "" ) {
    /*global ssl_cert*/
    _cmd_args.push(
      "--ssl-cert",
      ssl_cert);
  }
  if ( _ssl_key != "" ) {
    /*global ssl_key*/
    _cmd_args.push(
      "--ssl-key",
      ssl_key);
  }
  if ( _ssl_pass != "" ) {
    /*global ssl_pass*/
    _cmd_args.push(
      "--ssl-pass",
      ssl_pass);
  }

}

function
  _serve(
    _target_directory,
    _listen_uris,
    _target_port,
    _index_redirect,
    _debug_enabled,
    _config_file,
    _logging_disabled,
    _cors_enabled,
    _clipboard_disabled,
    _compression_disabled,
    _etag_disabled,
    _symlinks_enabled,
    _ssl_cert,
    _ssl_key,
    _ssl_pass,
    _port_switching_disabled) {
  let
    _output,
    _uri;
  const
    _cmd =
      "npx";
  const
    _cmd_args =
      _npx_cmdline_get(
        _target_directory,
        _listen_uris,
        _target_port,
        _index_redirect,
        _debug_enabled,
        _config_file,
        _logging_disabled,
        _cors_enabled,
        _clipboard_disabled,
        _compression_disabled,
        _etag_disabled,
        _symlinks_enabled,
        _ssl_cert,
        _ssl_key,
        _ssl_pass,
        _port_switching_disabled);
  const
    _serve_process =
      _spawn(
        _cmd,
        _cmd_args);
  const
    _serve_data_callback =
      _serve_data_callback_get(
        _output);
  _serve_process.stdout.on(
    'data',
    _serve_data_callback);
  const
    _serve_close_callback =
      _serve_close_callback_get(
        _output);
  _serve_process.stdout.on(
    'close',
    _serve_close_callback);
}

async function
  _safely_serve(
    _target_directory,
    _listen_uris,
    _target_port,
    _index_redirect,
    _debug_enabled,
    _config_file,
    _logging_disabled,
    _cors_enabled,
    _clipboard_disabled,
    _compression_disabled,
    _etag_disabled,
    _symlinks_enabled,
    _cert_new,
    _ssl_cert,
    _ssl_key,
    _ssl_pass,
    _port_switching_disabled,
    _keys_length,
    _serial_number,
    _validity_min,
    _validity_max,
    _domain_name,
    _country_name,
    _state_name,
    _locality_name,
    _organization_name,
    _organization_unit) {
  if ( ! _file_exists(
           _ssl_cert) &&
       _cert_new == "y" ) {
    const
      _mkdir_opts =
        { "recursive":
            true,
          "mode":
            0700 };
    const
      _mkdir_args = [
        _dirname(
          _ssl_cert),
        _mkdir_opts
      ];
    _mkdir.apply(
      null,
      _mkdir_args);
    const
      _cert_gen_opts = [
        _ssl_key,
        _keys_length,
        _serial_number,
        _validity_min,
        _validity_max,
        _domain_name,
        _country_name,
        _state_name,
        _locality_name,
        _organization_name,
        _organization_unit,
        _ssl_cert
      ];
    await _cert_gen.apply(
      null,
      _cert_gen_opts);
  }
  const
    _serve_opts = [
      _target_directory,
      _listen_uris,
      _target_port,
      _index_redirect,
      _debug_enabled,
      _config_file,
      _logging_disabled,
      _cors_enabled,
      _clipboard_disabled,
      _compression_disabled,
      _etag_disabled,
      _symlinks_enabled,
      _ssl_cert,
      _ssl_key,
      _ssl_pass,
      _port_switching_disabled
    ];
  _serve.apply(
    null,
    _serve_opts);
}

module.exports = {
  _path_encode:
    _path_encode,
  _safely_serve:
    _safely_serve,
  _serve:
    _serve
};
